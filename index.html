<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>培培的班表</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- 錯誤攔截器 -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const errorBox = document.getElementById('error-box');
            if (errorBox) {
                errorBox.style.display = 'block';
                document.getElementById('error-msg').innerText = msg + "\nLine: " + line;
            }
            return false;
        };
    </script>

    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-overflow-scrolling: touch; 
            margin: 0; padding: 0; overflow-x: hidden;
        }
        .hardware-accelerated {
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
            will-change: transform, opacity;
        }
        @keyframes aurora {
            0% { transform: translate(0, 0) scale(1); opacity: 0.6; }
            33% { transform: translate(30px, -50px) scale(1.1); opacity: 0.8; }
            66% { transform: translate(-20px, 20px) scale(0.95); opacity: 0.6; }
            100% { transform: translate(0, 0) scale(1); opacity: 0.6; }
        }
        .animate-aurora { animation: aurora 15s infinite cubic-bezier(0.4, 0, 0.2, 1); filter: blur(80px); }
        @keyframes ios-scale-in {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-ios-scale-in { animation: ios-scale-in 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* iOS Date Input Fix */
        input[type="date"] {
            -webkit-appearance: none;
            min-height: 3.5rem;
            background-color: transparent; 
        }
        
        /* Dark Mode Date Input Icon Fix */
        .dark input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        .dark input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        /* 物理彈跳開關效果 */
        .spring-toggle {
            transition: background-color 0.3s ease;
        }
        .spring-toggle::after {
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        ios: { bg: '#F2F2F7', card: 'rgba(255, 255, 255, 0.75)', blue: '#007AFF', red: '#FF3B30', green: '#34C759', gray: '#8E8E93' }
                    },
                    boxShadow: { 'ios': '0 4px 20px rgba(0, 0, 0, 0.08)', 'ios-deep': '0 10px 40px rgba(0, 0, 0, 0.15)' }
                }
            }
        }
    </script>
</head>
<body>
    <div id="error-box" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; color:red;">
        <h2 style="font-size:20px; font-weight:bold; margin-bottom:10px;">發生錯誤</h2>
        <p>請截圖此畫面回報，或重新整理網頁。</p>
        <pre id="error-msg" style="background:#f0f0f0; padding:10px; border-radius:8px; margin-top:10px; white-space:pre-wrap;"></pre>
        <button onclick="localStorage.clear(); location.reload();" style="margin-top:20px; padding:10px 20px; background:red; color:white; border:none; border-radius:8px;">重置所有資料 (修復)</button>
    </div>

    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy, addDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.Firebase = { initializeApp, getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy, addDoc, writeBatch };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const APP_ID = "glass-shift-prod"; 
        const STORAGE_KEY_SHIFTS = 'glassShifts_v4_ios18'; 
        const STORAGE_KEY_BASE = 'glassBaseRate_v4';
        const STORAGE_KEY_SPECIAL = 'glassSpecialRate_v4';

        // --- Helper Functions ---
        const getColorByName = (nameStr) => {
            const colorGradients = [
                'from-blue-400 to-cyan-400', 'from-emerald-400 to-teal-400',
                'from-orange-400 to-amber-400', 'from-purple-400 to-violet-400',
                'from-pink-400 to-rose-400', 'from-indigo-400 to-blue-500',
                'from-red-400 to-orange-500', 'from-lime-500 to-green-500',
                'from-fuchsia-400 to-pink-400', 'from-sky-400 to-blue-400'
            ];
            if (!nameStr) return colorGradients[0];
            let hash = 0;
            for (let i = 0; i < nameStr.length; i++) {
                hash = nameStr.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % colorGradients.length;
            return colorGradients[index];
        };

        const calculateBarPosition = (shift, currentDayDate) => {
            const dayStart = new Date(currentDayDate); dayStart.setHours(0, 0, 0, 0);
            const dayEnd = new Date(currentDayDate); dayEnd.setHours(24, 0, 0, 0);
            const shiftStart = new Date(shift.start); const shiftEnd = new Date(shift.end);
            const effectiveStart = shiftStart < dayStart ? dayStart : shiftStart;
            const effectiveEnd = shiftEnd > dayEnd ? dayEnd : shiftEnd;
            const startMinutes = effectiveStart.getHours() * 60 + effectiveStart.getMinutes();
            const durationMinutes = (effectiveEnd - effectiveStart) / (1000 * 60);
            const left = (startMinutes / 1440) * 100; const width = (durationMinutes / 1440) * 100;
            return { left: `${left}%`, width: `${width}%` };
        };

        const formatMoney = (val) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(val);
        const formatTime = (iso) => { const d = new Date(iso); return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`; };
        const formatDateFull = (iso) => { const d = new Date(iso); return `${d.getMonth() + 1}/${d.getDate()}`; };
        
        const toDateInputString = (dateObj) => {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const toTimeString = (dateObj) => dateObj.getHours().toString().padStart(2, '0') + ':' + dateObj.getMinutes().toString().padStart(2, '0');
        const normalizeTime = (val) => {
            if(!val) return "";
            val = val.trim().replace(/[^\d:]/g, '');
            if (!val.includes(':')) {
                if (val.length === 4) return val.slice(0, 2) + ':' + val.slice(2);
                if (val.length === 3) return '0' + val.slice(0, 1) + ':' + val.slice(1);
                if (val.length <= 2) return val.padStart(2, '0') + ':00';
            }
            const parts = val.split(':');
            if(parts.length === 2) { const h = parts[0].padStart(2, '0'); const m = parts[1].padStart(2, '0'); return `${h}:${m}`; }
            return val;
        };

        // --- Icons ---
        const Icon = ({ path, size = 24, className = "", fill = "none", stroke = "currentColor", strokeWidth = "2.5", style = {} }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke={stroke} strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className} style={style}>
                {path}
            </svg>
        );

        const Icons = {
            Calendar: (props) => <Icon {...props} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} />,
            Trash2: (props) => <Icon {...props} path={<><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></>} />,
            Plus: (props) => <Icon {...props} strokeWidth="3" path={<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>} />,
            Sparkles: (props) => <Icon {...props} path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></>} />,
            ChevronLeft: (props) => <Icon {...props} strokeWidth="3" path={<><polyline points="15 18 9 12 15 6"></polyline></>} />,
            ChevronRight: (props) => <Icon {...props} strokeWidth="3" path={<><polyline points="9 18 15 12 9 6"></polyline></>} />,
            X: (props) => <Icon {...props} strokeWidth="3" path={<><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>} />,
            Save: (props) => <Icon {...props} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></>} />,
            CheckCircle2: (props) => <Icon {...props} path={<><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></>} />,
            Edit3: (props) => <Icon {...props} path={<><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></>} />,
            Share2: (props) => <Icon {...props} path={<><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></>} />,
            Clock: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></>} />,
            Cloud: (props) => <Icon {...props} path={<><path d="M17.5 19c0-1.7-1.3-3-3-3h-11c-1.7 0-3 1.3-3 3s1.3 3 3 3h11c1.7 0 3-1.3 3-3z"></path><path d="M17.5 16c2.5 0 4.5-2 4.5-4.5S19.5 7 17 7c-.5 0-1 .1-1.5 .2C14.9 3.8 11.7 2 8.5 4 6.2 5.4 5 8.1 5.5 10.8"></path></>} />,
            WifiOff: (props) => <Icon {...props} path={<><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></>} />,
            Repeat: (props) => <Icon {...props} path={<><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></>} />,
            LogOut: (props) => <Icon {...props} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></>} />,
            User: (props) => <Icon {...props} path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></>} />,
            LogIn: (props) => <Icon {...props} path={<><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></>} />
        };

        // --- Components ---
        const SmartTimeInput = ({ value, onChange, label, inputRef, onEnter }) => {
            const handleFocus = (e) => e.target.select();
            const handleKeyDown = (e) => { if (e.key === 'Enter') { handleBlur(e); if (onEnter) { e.preventDefault(); onEnter(); } } };
            const handleInputChange = (e) => {
                let val = e.target.value; const digits = val.replace(/[^\d]/g, ''); const truncated = digits.slice(0, 4);
                let formatted = truncated; if (truncated.length > 2) { formatted = truncated.slice(0, 2) + ':' + truncated.slice(2); }
                onChange(formatted);
            };
            const handleBlur = (e) => { onChange(formatTimeStr(e.target.value)); };
            const formatTimeStr = (val) => { return normalizeTime(val); };

            const openPicker = (e) => {
                try {
                    const input = e.currentTarget.querySelector('input[type="time"]');
                    if (input && input.showPicker) {
                        input.showPicker();
                    } else if (input) {
                        input.focus();
                    }
                } catch(err) { console.log(err); }
            };

            return (
                <div className="w-full">
                    <label className="block text-[11px] font-semibold text-gray-500 dark:text-zinc-400 uppercase tracking-widest mb-2 ml-3">{label}</label>
                    <div className="flex items-center gap-2 relative"> 
                        <input 
                            ref={inputRef} 
                            type="text" 
                            inputMode="numeric" 
                            value={value} 
                            onChange={handleInputChange} 
                            onBlur={handleBlur} 
                            onFocus={handleFocus} 
                            onKeyDown={handleKeyDown} 
                            placeholder="如 1800" 
                            className="flex-1 h-14 bg-white/60 dark:bg-zinc-800/60 backdrop-blur-md border border-white/40 dark:border-white/10 rounded-3xl pl-5 pr-14 text-[17px] outline-none focus:ring-4 focus:ring-blue-400/20 transition-all font-semibold tracking-wide text-slate-800 dark:text-white shadow-sm min-w-0 placeholder:text-gray-400 dark:placeholder:text-zinc-600 relative z-10" 
                        />
                        
                        <div onClick={openPicker} className="absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 flex items-center justify-center text-slate-400 dark:text-zinc-400 active:scale-95 transition-all cursor-pointer hover:text-blue-500 dark:hover:text-blue-400 z-20">
                            <Icons.Clock size={20} strokeWidth="2.5" />
                            <input 
                                type="time" 
                                className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" 
                                value={value.includes(':') ? value : ''} 
                                onChange={(e) => onChange(e.target.value)}
                                onClick={(e) => { try { e.target.showPicker(); } catch(err){} }}
                            />
                        </div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onSkipLogin }) => {
            const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [isRegistering, setIsRegistering] = useState(false); const [error, setError] = useState(''); const [loading, setLoading] = useState(false);
            const handleSubmit = async (e) => {
                e.preventDefault(); setError(''); setLoading(true);
                const { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } = window.Firebase;
                try { if (isRegistering) await createUserWithEmailAndPassword(getAuth(), email, password); else await signInWithEmailAndPassword(getAuth(), email, password); } catch (err) { setError(err.message); } finally { setLoading(false); }
            };
            return (
                <div className="flex flex-col items-center justify-center min-h-[90vh] px-6 animate-ios-scale-in">
                    <div className="w-full max-w-sm bg-white/70 dark:bg-zinc-900/70 backdrop-blur-2xl border border-white/50 dark:border-white/10 rounded-[40px] p-8 shadow-ios-deep relative overflow-hidden transition-colors duration-500">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-[24px] flex items-center justify-center mx-auto mb-5 shadow-lg shadow-blue-500/40"><Icons.User size={40} strokeWidth="2" /></div>
                            <h2 className="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">{isRegistering ? '建立帳號' : '歡迎回來'}</h2>
                            <p className="text-base text-slate-500 dark:text-zinc-400 mt-2 font-medium">{isRegistering ? '同步您的班表到所有裝置' : '登入以存取您的雲端班表'}</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-5">
                            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full h-14 bg-gray-100/50 dark:bg-black/50 border-0 rounded-3xl px-5 text-[17px] font-medium outline-none focus:ring-4 focus:ring-blue-500/20 transition-all placeholder:text-gray-400 dark:placeholder:text-zinc-600 text-slate-900 dark:text-white" placeholder="電子郵件" required />
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full h-14 bg-gray-100/50 dark:bg-black/50 border-0 rounded-3xl px-5 text-[17px] font-medium outline-none focus:ring-4 focus:ring-blue-500/20 transition-all placeholder:text-gray-400 dark:placeholder:text-zinc-600 text-slate-900 dark:text-white" placeholder="密碼" required />
                            {error && <div className="text-red-500 dark:text-red-400 text-sm bg-red-50/80 dark:bg-red-900/20 p-3 rounded-2xl text-center font-bold">{error}</div>}
                            <button type="submit" disabled={loading} className="w-full h-14 bg-slate-900 dark:bg-white hover:bg-slate-800 dark:hover:bg-gray-200 text-white dark:text-black text-[17px] font-bold rounded-full shadow-lg shadow-slate-900/20 active:scale-95 transition-all disabled:opacity-70">{loading ? '處理中...' : (isRegistering ? '繼續' : '登入')}</button>
                        </form>
                        <div className="mt-6 text-center space-y-4">
                            <button onClick={() => { setIsRegistering(!isRegistering); setError(''); }} className="text-[15px] text-blue-600 dark:text-blue-400 font-semibold hover:text-blue-700 transition-colors">{isRegistering ? '已有帳號？登入' : '沒有帳號？註冊'}</button>
                            <button onClick={onSkipLogin} className="text-[15px] font-semibold text-slate-400 dark:text-zinc-500 hover:text-slate-600 transition-colors block w-full py-2">返回本機模式</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [shifts, setShifts] = useState([]); const [baseRate, setBaseRate] = useState(183); const [specialRate, setSpecialRate] = useState(250);
            const [user, setUser] = useState(null); const [authInitialized, setAuthInitialized] = useState(false); const [isCloudMode, setIsCloudMode] = useState(false); const [isOfflineMode, setIsOfflineMode] = useState(false);
            const [name, setName] = useState(''); const [shiftDate, setShiftDate] = useState(''); const [startTimeStr, setStartTimeStr] = useState(''); const [endTimeStr, setEndTimeStr] = useState(''); const [isSpecial, setIsSpecial] = useState(false);
            const [showInput, setShowInput] = useState(false); const [editId, setEditId] = useState(null); const [isRepeat, setIsRepeat] = useState(false); const [repeatEndDate, setRepeatEndDate] = useState('');
            const startTimeRef = useRef(null); const endTimeRef = useRef(null);
            const nameInputRef = useRef(null); 
            const [currentDate, setCurrentDate] = useState(new Date()); const [selectedDate, setSelectedDate] = useState(null); const [saveStatus, setSaveStatus] = useState('idle');

            // Dark Mode Detection Logic
            useEffect(() => {
                const matchMedia = window.matchMedia('(prefers-color-scheme: dark)');
                
                const handleChange = (e) => {
                    if (e.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                };

                // Initial check
                handleChange(matchMedia);

                // Listener
                matchMedia.addEventListener('change', handleChange);
                
                return () => matchMedia.removeEventListener('change', handleChange);
            }, []);

            useEffect(() => {
                if (showInput) {
                    document.body.style.overflow = 'hidden';
                    
                    // 針對行動裝置優化：延遲聚焦以確保鍵盤彈出
                    const timer1 = setTimeout(() => nameInputRef.current?.focus(), 100);
                    const timer2 = setTimeout(() => nameInputRef.current?.focus(), 300); // 備用，防止動畫干擾
                    
                    return () => { clearTimeout(timer1); clearTimeout(timer2); };
                } else {
                    document.body.style.overflow = '';
                }
            }, [showInput]);

            useEffect(() => {
                const initData = async () => {
                    if (typeof window.Firebase !== 'undefined') {
                        try {
                            const { initializeApp, getAuth, onAuthStateChanged, getFirestore } = window.Firebase;
                            const config = { apiKey: "AIzaSyB1qrSjTOMHou6JR07v9atORLG_aQPrFSU", authDomain: "glass-shift.firebaseapp.com", projectId: "glass-shift", storageBucket: "glass-shift.firebasestorage.app", messagingSenderId: "1004961141606", appId: "1:1004961141606:web:e0ee0ac3a47dae4272eea7" };
                            const app = initializeApp(config); const auth = getAuth(app); const db = getFirestore(app); window.db = db;
                            onAuthStateChanged(auth, (u) => { 
                                setUser(u); 
                                setAuthInitialized(true); 
                                if (u) { 
                                    setIsCloudMode(true); 
                                    setIsOfflineMode(false); 
                                } else { 
                                    setIsCloudMode(false);
                                    // 修正：若沒有使用者登入，預設為本機模式 (跳過登入畫面)
                                    setIsOfflineMode(true); 
                                } 
                            });
                        } catch (e) { 
                            console.error("Firebase Init", e); 
                            setAuthInitialized(true); 
                            setIsCloudMode(false);
                            // 修正：若 Firebase 錯誤，預設為本機模式
                            setIsOfflineMode(true); 
                        }
                    } else { 
                        setAuthInitialized(true); 
                        setIsCloudMode(false);
                        // 修正：若沒有 Firebase 環境，預設為本機模式
                        setIsOfflineMode(true);
                    }
                };
                initData();
            }, []);

            const loadFromLocal = () => {
                try {
                    const savedShifts = localStorage.getItem(STORAGE_KEY_SHIFTS);
                    if (savedShifts) {
                        const parsed = JSON.parse(savedShifts);
                        setShifts(Array.isArray(parsed) ? parsed : []);
                    }
                    const savedBase = localStorage.getItem(STORAGE_KEY_BASE); if (savedBase) setBaseRate(savedBase);
                    const savedSpecial = localStorage.getItem(STORAGE_KEY_SPECIAL); if (savedSpecial) setSpecialRate(savedSpecial);
                } catch (e) { console.error(e); setShifts([]); }
            };

            useEffect(() => { if (isOfflineMode) loadFromLocal(); }, [isOfflineMode]);

            useEffect(() => {
                if (!user || isOfflineMode) return; 
                const { onSnapshot, collection, query, doc } = window.Firebase;
                const q = query(collection(window.db, 'artifacts', APP_ID, 'users', user.uid, 'shifts')); 
                setSaveStatus('syncing');
                const unsubscribeShifts = onSnapshot(q, (snapshot) => {
                    const loadedShifts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setShifts(loadedShifts);
                    setSaveStatus('saved');
                }, (error) => { console.error(error); setSaveStatus('error'); });
                const settingsRef = doc(window.db, 'artifacts', APP_ID, 'users', user.uid, 'settings', 'rates');
                const unsubscribeSettings = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.baseRate) setBaseRate(data.baseRate);
                        if (data.specialRate) setSpecialRate(data.specialRate);
                    }
                });
                return () => { unsubscribeShifts(); unsubscribeSettings(); };
            }, [user, isOfflineMode]);

            useEffect(() => {
                // 只有在明確處於「本機模式」時才寫入 LocalStorage
                // 避免在登入畫面或模式切換時意外覆蓋資料
                if (!isOfflineMode) return;

                try {
                    setSaveStatus('saving');
                    localStorage.setItem(STORAGE_KEY_SHIFTS, JSON.stringify(shifts));
                    localStorage.setItem(STORAGE_KEY_BASE, baseRate);
                    localStorage.setItem(STORAGE_KEY_SPECIAL, specialRate);
                    setTimeout(() => setSaveStatus('saved'), 500);
                } catch (e) { console.error(e); }
            // eslint-disable-next-line react-hooks/exhaustive-deps
            }, [shifts, baseRate, specialRate]); // 移除 isOfflineMode 依賴，防止模式切換瞬間的資料覆寫

            const handleLogout = async () => { if (window.confirm('確定要登出嗎？')) { await window.Firebase.signOut(window.Firebase.getAuth()); setShifts([]); } };
            const handleGoToLogin = () => { setIsOfflineMode(false); setShifts([]); };

            const batchSaveToCloud = async (shiftsToAdd) => {
                if (!user) return;
                const { writeBatch, doc, collection, addDoc } = window.Firebase; setSaveStatus('saving');
                try {
                    if (shiftsToAdd.length === 1) { const { id, ...data } = shiftsToAdd[0]; await addDoc(collection(window.db, 'artifacts', APP_ID, 'users', user.uid, 'shifts'), data); } 
                    else {
                        const batch = writeBatch(window.db);
                        shiftsToAdd.forEach(shift => { const { id, ...data } = shift; const newDocRef = doc(collection(window.db, 'artifacts', APP_ID, 'users', user.uid, 'shifts')); batch.set(newDocRef, data); });
                        await batch.commit();
                    }
                    setSaveStatus('saved');
                } catch (e) { console.error(e); setSaveStatus('error'); alert("儲存失敗: " + e.message); }
            };

            const saveDataToCloud = async (newShift, deleteId = null) => {
                if (!user) return;
                const { setDoc, deleteDoc, doc, addDoc, collection } = window.Firebase; setSaveStatus('saving');
                try {
                    if (deleteId) await deleteDoc(doc(window.db, 'artifacts', APP_ID, 'users', user.uid, 'shifts', deleteId));
                    else if (newShift) {
                        if (newShift.id && typeof newShift.id === 'string' && newShift.id.length > 15) await setDoc(doc(window.db, 'artifacts', APP_ID, 'users', user.uid, 'shifts', newShift.id), newShift);
                        else { const { id, ...shiftData } = newShift; await addDoc(collection(window.db, 'artifacts', APP_ID, 'users', user.uid, 'shifts'), shiftData); }
                    }
                    setSaveStatus('saved');
                } catch (e) { console.error(e); setSaveStatus('error'); alert("儲存失敗: " + e.message); }
            };

            const deleteMonthRecords = () => {
                const targetYear = currentDate.getFullYear(); const targetMonth = currentDate.getMonth();
                const toDelete = shifts.filter(s => { const d = new Date(s.start); return d.getFullYear() === targetYear && d.getMonth() === targetMonth; });
                if (toDelete.length === 0) return;
                if (window.confirm(`確定要刪除 ${targetYear}年${targetMonth + 1}月 的所有 ${toDelete.length} 筆紀錄嗎？`)) {
                    if (isCloudMode && !isOfflineMode) toDelete.forEach(s => saveDataToCloud(null, s.id));
                    else setShifts(shifts.filter(s => { const d = new Date(s.start); return !(d.getFullYear() === targetYear && d.getMonth() === targetMonth); }));
                }
            };

            const exportToCalendar = () => {
                if (shifts.length === 0) { alert("沒有班表可匯出"); return; }
                const formatICSDate = (dateStr) => dateStr.replace(/[-:]/g, '').split('.')[0] + 'Z';
                let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//GlassWorkShift//TW\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n";
                shifts.forEach(shift => {
                    const startDate = formatICSDate(new Date(shift.start).toISOString());
                    const endDate = formatICSDate(new Date(shift.end).toISOString());
                    icsContent += `BEGIN:VEVENT\nSUMMARY:${shift.name}\nDTSTART:${startDate}\nDTEND:${endDate}\nDESCRIPTION:薪資預估: $${shift.totalPay} | 時數: ${shift.duration.toFixed(1)}hr\nSTATUS:CONFIRMED\nEND:VEVENT\n`;
                });
                icsContent += "END:VCALENDAR";
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const link = document.createElement('a'); link.href = window.URL.createObjectURL(blob); link.setAttribute('download', '我的班表.ics'); document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const goToToday = () => { const today = new Date(); setCurrentDate(today); setSelectedDate(today); };
            const changeMonth = (offset) => { setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1)); };

            const { days, firstDay, year, month } = useMemo(() => {
                const year = currentDate.getFullYear(); const month = currentDate.getMonth();
                const days = new Date(year, month + 1, 0).getDate(); const firstDay = new Date(year, month, 1).getDay();
                return { days, firstDay, year, month };
            }, [currentDate]);

            const getShiftStatusForDay = (day) => {
                const checkStart = new Date(year, month, day, 0, 0, 0); const checkEnd = new Date(year, month, day, 23, 59, 59);
                const dayShifts = shifts.filter(s => { const start = new Date(s.start); const end = new Date(s.end); return start < checkEnd && end > checkStart; });
                if (dayShifts.length === 0) return null;
                return dayShifts.some(s => s.isSpecial) ? 'special' : 'normal';
            };

            const handleDateClick = (day) => { const clickedDate = new Date(year, month, day); if (selectedDate && clickedDate.getTime() === selectedDate.getTime()) setSelectedDate(null); else setSelectedDate(clickedDate); };

            const monthlyShifts = useMemo(() => {
                const year = currentDate.getFullYear(); const month = currentDate.getMonth();
                return shifts.filter(s => { const d = new Date(s.start); return d.getFullYear() === year && d.getMonth() === month; }).sort((a, b) => new Date(b.start) - new Date(a.start)); 
            }, [shifts, currentDate]);

            const totalIncome = useMemo(() => monthlyShifts.reduce((acc, curr) => acc + curr.totalPay, 0), [monthlyShifts]);
            const totalHours = useMemo(() => monthlyShifts.reduce((acc, curr) => acc + curr.duration, 0), [monthlyShifts]);

            const filteredShifts = useMemo(() => {
                if (selectedDate) {
                    const startOfDay = new Date(selectedDate); startOfDay.setHours(0, 0, 0, 0);
                    const endOfDay = new Date(selectedDate); endOfDay.setHours(23, 59, 59, 999);
                    return shifts.filter(shift => { const s = new Date(shift.start); const e = new Date(shift.end); return s < endOfDay && e > startOfDay; }).sort((a, b) => new Date(a.start) - new Date(b.start)); 
                } else { return monthlyShifts; }
            }, [shifts, selectedDate, monthlyShifts]);

            const handleSaveShift = async () => {
                const safeStartStr = normalizeTime(startTimeStr); const safeEndStr = normalizeTime(endTimeStr);
                
                if (!name || !shiftDate || !safeStartStr || !safeEndStr) { 
                    alert("請填寫完整資訊 (名稱、日期、開始與結束時間)"); 
                    return; 
                }
                
                const baseStartDateTime = new Date(`${shiftDate}T${safeStartStr}:00`); 
                let baseEndDateTime = new Date(`${shiftDate}T${safeEndStr}:00`);
                
                if (isNaN(baseStartDateTime.getTime()) || isNaN(baseEndDateTime.getTime())) { 
                    alert("時間格式不正確"); 
                    return; 
                }
                
                if (baseEndDateTime <= baseStartDateTime) baseEndDateTime.setDate(baseEndDateTime.getDate() + 1);
                
                const durationMs = baseEndDateTime - baseStartDateTime; 
                const durationHours = durationMs / (1000 * 60 * 60);
                const rate = isSpecial ? parseFloat(specialRate) : parseFloat(baseRate); 
                const pay = Math.round(durationHours * rate);
                
                const shiftsToSave = [];
                if (isRepeat && repeatEndDate && !editId) {
                    const repeatUntil = new Date(repeatEndDate); repeatUntil.setHours(23, 59, 59, 999);
                    let currentStart = new Date(baseStartDateTime); let currentEnd = new Date(baseEndDateTime);
                    while (currentStart <= repeatUntil) {
                        shiftsToSave.push({ name, start: currentStart.toISOString(), end: currentEnd.toISOString(), duration: durationHours, rate, isSpecial, totalPay: pay, id: isCloudMode && !isOfflineMode ? null : Date.now() + Math.random().toString() });
                        currentStart.setDate(currentStart.getDate() + 7); currentEnd.setDate(currentEnd.getDate() + 7);
                    }
                } else {
                    shiftsToSave.push({ name, start: baseStartDateTime.toISOString(), end: baseEndDateTime.toISOString(), duration: durationHours, rate, isSpecial, totalPay: pay, id: editId ? editId : (isCloudMode && !isOfflineMode ? null : Date.now()) });
                }

                try {
                    if (isCloudMode && !isOfflineMode) {
                        if (typeof window.Firebase === 'undefined') {
                            throw new Error("Firebase not loaded");
                        }
                        const { doc, setDoc } = window.Firebase; 
                        const settingsRef = doc(window.db, 'artifacts', APP_ID, 'users', user.uid, 'settings', 'rates');
                        setDoc(settingsRef, { baseRate: String(baseRate), specialRate: String(specialRate) }, { merge: true }).catch(e => console.error(e));
                        
                        if (editId) {
                            await saveDataToCloud(shiftsToSave[0]); 
                        } else {
                            await batchSaveToCloud(shiftsToSave);
                        }
                    } else {
                        if (editId) {
                            setShifts(shifts.map(s => s.id === editId ? shiftsToSave[0] : s)); 
                        } else {
                            setShifts([...shiftsToSave, ...shifts]);
                        }
                    }
                    closeForm();
                } catch (e) {
                    console.error(e);
                    alert("儲存時發生錯誤: " + e.message);
                }
            };

            const handleEdit = (shift) => {
                setEditId(shift.id); setName(shift.name);
                const s = new Date(shift.start); const e = new Date(shift.end);
                setShiftDate(toDateInputString(s)); setStartTimeStr(toTimeString(s)); setEndTimeStr(toTimeString(e));
                setIsSpecial(shift.isSpecial); setIsRepeat(false); setRepeatEndDate(''); setShowInput(true);
            };
            const handleDelete = (id) => { if (window.confirm('確定要刪除這筆班表嗎？')) { if (isCloudMode && !isOfflineMode) saveDataToCloud(null, id); else setShifts(shifts.filter(s => s.id !== id)); } };
            
            // --- Logic Split: resetFormState & closeForm ---
            const resetFormState = () => {
                setName(''); 
                setShiftDate(''); 
                setStartTimeStr(''); 
                setEndTimeStr(''); 
                setIsSpecial(false); 
                setEditId(null); 
                setIsRepeat(false); 
                setRepeatEndDate(''); 
            };

            const closeForm = () => {
                resetFormState();
                setShowInput(false);
            };

            const openAddModal = () => { 
                try {
                    resetFormState(); // Just clear data
                    let targetDate = selectedDate ? new Date(selectedDate) : new Date(); 
                    setShiftDate(toDateInputString(targetDate)); 
                    setStartTimeStr('09:00'); 
                    setEndTimeStr('17:00'); 
                    setShowInput(true); // Then open modal
                } catch (err) {
                    console.error("Open modal error:", err);
                    alert("開啟視窗時發生錯誤: " + err.message);
                }
            };

            if (!authInitialized) return <div className="min-h-screen flex items-center justify-center text-slate-400 dark:text-zinc-500 font-medium bg-gray-100 dark:bg-black">載入中...</div>;

            return (
                <div className="min-h-screen w-full relative overflow-hidden font-sans text-slate-800 dark:text-slate-100 selection:bg-blue-200 selection:text-blue-900 bg-gray-100 dark:bg-black transition-colors duration-500">
                    <div className="fixed inset-0 z-0 pointer-events-none">
                        <div className="absolute top-0 left-0 w-full h-full bg-[#f2f2f7] dark:bg-black transition-colors duration-500"></div>
                        <div className="absolute top-[-20%] left-[-20%] w-[80%] h-[80%] bg-blue-300/30 dark:bg-blue-900/10 rounded-full mix-blend-screen dark:mix-blend-lighten filter blur-[120px] animate-aurora"></div>
                        <div className="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] bg-purple-300/30 dark:bg-purple-900/10 rounded-full mix-blend-screen dark:mix-blend-lighten filter blur-[100px] animate-aurora animation-delay-2000"></div>
                        <div className="absolute top-[40%] left-[30%] w-[40%] h-[40%] bg-pink-200/20 dark:bg-pink-900/5 rounded-full mix-blend-screen dark:mix-blend-lighten filter blur-[90px] animate-aurora animation-delay-4000"></div>
                    </div>

                    {(!user && !isOfflineMode) ? (
                        <LoginScreen onSkipLogin={() => setIsOfflineMode(true)} />
                    ) : (
                        <div className="relative z-10 container mx-auto px-5 py-8 max-w-md md:max-w-6xl min-h-screen flex flex-col gap-8 animate-ios-scale-in">
                            <div className="flex justify-between items-end px-2">
                                <div>
                                    <div className="text-[13px] font-semibold text-gray-500 dark:text-zinc-400 uppercase tracking-wider mb-1 flex items-center gap-2">
                                        {(user && !isOfflineMode) ? 
                                            <span className="flex items-center gap-1.5"><Icons.Cloud size={14} className="text-blue-500"/> 雲端同步</span> :
                                            <span className="flex items-center gap-1.5"><Icons.WifiOff size={14} className="text-gray-400"/> 本機模式</span>
                                        }
                                    </div>
                                    <h1 className="text-[34px] font-bold text-slate-900 dark:text-white leading-tight tracking-tight">工作班表</h1>
                                </div>
                                <div className="flex items-center gap-3 pb-1">
                                    <button onClick={exportToCalendar} className="w-10 h-10 rounded-full bg-white/60 dark:bg-zinc-800/60 backdrop-blur-md shadow-sm flex items-center justify-center text-blue-600 dark:text-blue-400 hover:bg-white dark:hover:bg-zinc-700 hover:scale-105 active:scale-95 transition-all"><Icons.Share2 size={20} /></button>
                                    {(user && !isOfflineMode) ? (
                                        <button onClick={handleLogout} className="w-10 h-10 rounded-full bg-gray-200/60 dark:bg-zinc-700/60 backdrop-blur-md shadow-sm flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-zinc-600 hover:scale-105 active:scale-95 transition-all"><Icons.LogOut size={20} /></button>
                                    ) : (
                                        <button onClick={handleGoToLogin} className="w-10 h-10 rounded-full bg-blue-500/10 dark:bg-blue-500/20 backdrop-blur-md shadow-sm flex items-center justify-center text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/30 hover:scale-105 active:scale-95 transition-all"><Icons.LogIn size={20} /></button>
                                    )}
                                </div>
                            </div>

                            <div className="flex flex-col md:flex-row gap-8 items-start">
                                <div className="w-full md:w-5/12 lg:w-4/12 flex flex-col gap-6 md:sticky md:top-8">
                                    <div className="bg-white/60 dark:bg-zinc-900/60 backdrop-blur-2xl border border-white/40 dark:border-white/10 rounded-[32px] p-6 shadow-ios relative overflow-hidden group transition-colors duration-300">
                                        <div className="flex justify-between items-start mb-4">
                                            <div><div className="text-[15px] font-semibold text-gray-500 dark:text-zinc-400 mb-1">本月預估薪資</div><div className="text-4xl font-bold text-slate-900 dark:text-white tracking-tight">{formatMoney(totalIncome)}</div></div>
                                            <div className="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center text-white shadow-lg shadow-green-500/30"><span className="font-bold text-lg">$</span></div>
                                        </div>
                                        <div className="flex items-center justify-between pt-4 border-t border-gray-200/50 dark:border-white/10"><span className="text-sm font-medium text-gray-500 dark:text-zinc-400">累積工時</span><span className="text-xl font-bold text-slate-800 dark:text-gray-100">{totalHours.toFixed(1)} <span className="text-sm font-medium text-gray-400 dark:text-zinc-500">hr</span></span></div>
                                    </div>

                                    <div className="bg-white/60 dark:bg-zinc-900/60 backdrop-blur-2xl border border-white/40 dark:border-white/10 rounded-[32px] p-6 shadow-ios transition-colors duration-300">
                                        <div className="flex justify-between items-center mb-6">
                                            <button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors text-blue-600 dark:text-blue-400"><Icons.ChevronLeft size={22}/></button>
                                            <div className="text-center"><h2 className="text-xl font-bold text-slate-900 dark:text-white">{year}年 {month + 1}月</h2></div>
                                            <button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors text-blue-600 dark:text-blue-400"><Icons.ChevronRight size={22}/></button>
                                        </div>
                                        <div className="grid grid-cols-7 text-center mb-4">{['日', '一', '二', '三', '四', '五', '六'].map(d => (<div key={d} className="text-[13px] font-semibold text-gray-400 dark:text-zinc-500">{d}</div>))}</div>
                                        <div className="grid grid-cols-7 gap-y-3">
                                            {Array.from({ length: firstDay }).map((_, i) => <div key={`empty-${i}`} />)}
                                            {Array.from({ length: days }).map((_, i) => {
                                                const day = i + 1; const status = getShiftStatusForDay(day); const isSelected = selectedDate && selectedDate.getDate() === day && selectedDate.getMonth() === month; const isToday = new Date().getDate() === day && new Date().getMonth() === month && new Date().getFullYear() === year;
                                                return (<div key={day} className="flex justify-center"><button onClick={() => handleDateClick(day)} className={`w-10 h-10 flex flex-col items-center justify-center rounded-full text-[17px] font-medium transition-all duration-300 relative ${isSelected ? 'bg-black dark:bg-white text-white dark:text-black shadow-lg scale-110' : 'text-slate-900 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-zinc-800'} ${isToday && !isSelected ? 'text-blue-600 dark:text-blue-400 font-bold bg-blue-50 dark:bg-blue-900/30' : ''}`}>{day}{status && (<span className={`absolute bottom-1.5 w-1.5 h-1.5 rounded-full ${status === 'special' ? 'bg-pink-500' : (isSelected ? 'bg-white dark:bg-black' : 'bg-blue-500')}`}></span>)}</button></div>);
                                            })}
                                        </div>
                                        <div className="mt-6 flex justify-between items-center">
                                            <button onClick={deleteMonthRecords} className="text-xs font-medium text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 px-3 py-1.5 rounded-full transition-colors flex items-center gap-1"><Icons.Trash2 size={14}/> 清除本月</button>
                                            <button onClick={goToToday} className="text-xs font-bold text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 hover:bg-blue-100 dark:hover:bg-blue-900/50 px-3 py-1.5 rounded-full transition-colors">回今天</button>
                                        </div>
                                    </div>
                                </div>

                                <div className="w-full md:w-7/12 lg:w-8/12 flex flex-col gap-6">
                                    {selectedDate && (
                                        <div className="bg-white/60 dark:bg-zinc-900/60 backdrop-blur-2xl border border-white/40 dark:border-white/10 rounded-[28px] p-5 shadow-ios animate-ios-slide-up transition-colors duration-300">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-[15px] font-semibold text-gray-500 dark:text-zinc-400">{selectedDate.getMonth()+1}月{selectedDate.getDate()}日 時間分配</h3>
                                                {filteredShifts.length > 0 && (<span className="text-xs font-bold text-white dark:text-black bg-slate-900 dark:bg-white px-3 py-1 rounded-full">{filteredShifts.reduce((acc,s) => acc + s.duration, 0).toFixed(1)} 小時</span>)}
                                            </div>
                                            <div className="relative h-12 w-full mt-2">
                                                <div className="absolute top-3 left-0 right-0 h-6 bg-gray-200/50 dark:bg-zinc-800/50 rounded-full overflow-hidden"></div>
                                                {filteredShifts.length === 0 ? (<div className="absolute top-3 w-full text-center text-xs text-gray-400 dark:text-zinc-500 mt-1.5 font-medium">本日無排班</div>) : (filteredShifts.map(shift => { const style = calculateBarPosition(shift, selectedDate); const colorClass = getColorByName(shift.name); return (<div key={shift.id} className={`absolute top-3 h-6 rounded-full shadow-sm border-2 border-white dark:border-zinc-900 transition-all hover:scale-y-110 cursor-help bg-gradient-to-r ${colorClass}`} style={style}></div>); }))}
                                                <div className="absolute inset-0 flex justify-between text-[10px] text-gray-400 dark:text-zinc-600 font-medium pt-10 px-1 pointer-events-none"><span>00:00</span><span>06:00</span><span>12:00</span><span>18:00</span><span>24:00</span></div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="flex justify-between items-center px-2">
                                        <div className="flex items-center gap-0.5">
                                            <h2 className="text-2xl font-bold text-slate-900 dark:text-white tracking-tight">詳細列表</h2>
                                            {selectedDate && (
                                                <button onClick={() => setSelectedDate(null)} className="text-xs font-semibold text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 hover:bg-blue-100 dark:hover:bg-blue-900/50 px-3 py-1.5 rounded-full transition-colors flex items-center gap-1 ml-2">
                                                    顯示全部 <Icons.X size={12}/>
                                                </button>
                                            )}
                                        </div>
                                        <button onClick={(e) => { e.preventDefault(); openAddModal(); }} className="relative z-50 flex items-center gap-2 bg-slate-900 dark:bg-white hover:bg-slate-800 dark:hover:bg-gray-200 text-white dark:text-black pl-4 pr-5 py-2.5 rounded-full shadow-lg shadow-slate-900/20 active:scale-95 transition-all text-[15px] font-bold" type="button"><Icons.Plus size={18} /> 記一筆</button>
                                    </div>

                                    <div className="pb-32 space-y-4">
                                        {filteredShifts.length === 0 ? (
                                            <div className="flex flex-col items-center justify-center py-16 opacity-40"><div className="bg-gray-200 dark:bg-zinc-800 rounded-full p-4 mb-4"><Icons.Calendar size={32} className="text-gray-500 dark:text-zinc-500"/></div><p className="text-[17px] font-medium text-gray-500 dark:text-zinc-500">{selectedDate ? '點擊右上方按鈕新增' : '本月還沒有資料'}</p></div>
                                        ) : (
                                            filteredShifts.map((shift) => {
                                                const colorClass = getColorByName(shift.name);
                                                return (
                                                    <div key={shift.id} className="group relative bg-white/70 dark:bg-zinc-900/70 hover:bg-white/90 dark:hover:bg-zinc-900/90 backdrop-blur-xl border border-white/50 dark:border-white/10 rounded-[24px] p-5 transition-all duration-300 hover:shadow-lg active:scale-[0.99]">
                                                        <div className="flex justify-between items-center">
                                                            <div className="flex items-center gap-4">
                                                                <div className={`w-1.5 h-12 rounded-full shadow-sm bg-gradient-to-b ${colorClass}`}></div>
                                                                <div>
                                                                    {/* 修正：使用 span 包裹圖示並強制設定寬高與對齊，避免裁切，加入 py-0.5 和 mt-0.5 增加空間 */}
                                                                    <h4 className="font-bold text-slate-900 dark:text-white text-[19px] flex items-center gap-0.5 mb-1 py-0.5">
                                                                        {shift.name}
                                                                        {shift.isSpecial && (
                                                                            <span className="inline-flex items-center justify-center w-6 h-6 shrink-0">
                                                                                <Icons.Sparkles size={16} className="text-yellow-500" fill="currentColor" strokeWidth={0} style={{ overflow: 'visible' }} />
                                                                            </span>
                                                                        )}
                                                                    </h4>
                                                                    <div className="text-[15px] text-gray-500 dark:text-zinc-400 font-medium flex items-center gap-2"><span className="bg-gray-100/80 dark:bg-zinc-800 px-2 py-0.5 rounded-md text-gray-600 dark:text-gray-300">{formatDateFull(shift.start)}</span>{formatTime(shift.start)} - {formatTime(shift.end)}</div>
                                                                </div>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className="text-[19px] font-bold text-slate-900 dark:text-white tracking-tight">{formatMoney(shift.totalPay)}</div>
                                                                <div className="text-[13px] font-medium text-gray-400 dark:text-zinc-500 mt-0.5">{shift.duration.toFixed(1)}h × ${shift.rate}</div>
                                                            </div>
                                                        </div>
                                                        <div className="absolute top-1/2 -translate-y-1/2 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                            <button onClick={(e) => { e.stopPropagation(); handleEdit(shift); }} className="w-10 h-10 rounded-full bg-gray-100 dark:bg-zinc-800 hover:bg-blue-100 dark:hover:bg-zinc-700 text-blue-600 dark:text-blue-400 flex items-center justify-center shadow-sm transition-transform hover:scale-110"><Icons.Edit3 size={18} /></button>
                                                            <button onClick={(e) => { e.stopPropagation(); handleDelete(shift.id); }} className="w-10 h-10 rounded-full bg-gray-100 dark:bg-zinc-800 hover:bg-red-100 dark:hover:bg-zinc-700 text-red-500 dark:text-red-400 flex items-center justify-center shadow-sm transition-transform hover:scale-110"><Icons.Trash2 size={18} /></button>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showInput && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/20 dark:bg-black/80 backdrop-blur-sm transition-all duration-300">
                            <div className="bg-white/80 dark:bg-zinc-900/90 backdrop-blur-3xl border border-white/60 dark:border-white/10 w-full max-w-sm rounded-[40px] shadow-2xl animate-ios-scale-in relative flex flex-col max-h-[85vh] transition-colors duration-300" onClick={e => e.stopPropagation()}>
                                {/* Fixed Header */}
                                <div className="shrink-0 p-6 pb-0">
                                    <div className="absolute top-3 left-1/2 -translate-x-1/2 w-12 h-1.5 bg-gray-300 dark:bg-zinc-700 rounded-full"></div>
                                    <div className="flex justify-between items-center mb-6 mt-2">
                                        <h3 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">{editId ? '編輯班次' : '新增班次'}</h3>
                                        <button onClick={closeForm} className="w-8 h-8 rounded-full bg-gray-200/50 dark:bg-zinc-800/50 hover:bg-gray-200 dark:hover:bg-zinc-700 flex items-center justify-center text-gray-500 dark:text-gray-300 transition-colors"><Icons.X size={18} strokeWidth="3"/></button>
                                    </div>
                                </div>

                                {/* Scrollable Content */}
                                <div className="flex-1 overflow-y-auto px-6 custom-scrollbar">
                                    <div className="space-y-6 pb-4">
                                        <div>
                                            <label className="block text-[11px] font-semibold text-gray-500 dark:text-zinc-400 uppercase tracking-widest mb-2 ml-3">名稱</label>
                                            <input 
                                                ref={nameInputRef} 
                                                autoFocus
                                                type="text" 
                                                value={name} 
                                                onChange={(e) => setName(e.target.value)} 
                                                placeholder="如：早班" 
                                                className="w-full h-14 bg-white/60 dark:bg-zinc-800/60 backdrop-blur-md border border-white/40 dark:border-white/10 rounded-3xl px-5 text-[17px] outline-none focus:ring-4 focus:ring-blue-400/20 transition-all font-semibold tracking-wide text-slate-800 dark:text-white shadow-sm placeholder:text-gray-400 dark:placeholder:text-zinc-600"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-[11px] font-semibold text-gray-500 dark:text-zinc-400 uppercase tracking-widest mb-2 ml-3">日期</label>
                                            <input type="date" value={shiftDate} onChange={(e) => setShiftDate(e.target.value)} className="w-full h-14 bg-white/60 dark:bg-zinc-800/60 backdrop-blur-md border border-white/40 dark:border-white/10 rounded-3xl px-5 text-[17px] outline-none focus:ring-4 focus:ring-blue-400/20 transition-all font-semibold tracking-wide text-slate-800 dark:text-white shadow-sm appearance-none"/>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4"><SmartTimeInput label="開始時間" value={startTimeStr} onChange={setStartTimeStr} inputRef={startTimeRef} onEnter={() => endTimeRef.current.focus()} /><SmartTimeInput label="結束時間" value={endTimeStr} onChange={setEndTimeStr} inputRef={endTimeRef} onEnter={handleSaveShift} /></div>
                                        
                                        {!editId && (<div className="bg-white/50 dark:bg-zinc-800/50 border border-white/40 dark:border-white/10 rounded-[28px] p-4 flex items-center justify-between"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded-full flex items-center justify-center"><Icons.Repeat size={20} /></div><label className="text-[15px] font-semibold text-slate-700 dark:text-slate-200">每週重複</label></div><div className="flex items-center">
                                            <label className="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" checked={isRepeat} onChange={(e) => {
                                                    const checked = e.target.checked;
                                                    setIsRepeat(checked);
                                                    if (checked && !repeatEndDate) {
                                                        const nextMonth = new Date();
                                                        nextMonth.setDate(nextMonth.getDate() + 7);
                                                        setRepeatEndDate(toDateInputString(nextMonth));
                                                    }
                                                }} className="sr-only peer" />
                                                <div className="w-14 h-8 bg-gray-200 dark:bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white spring-toggle after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:shadow-sm peer-checked:bg-green-500"></div>
                                            </label>
                                        </div></div>)}
                                        
                                        {isRepeat && !editId && (<div className="animate-ios-slide-up"><label className="block text-[11px] font-semibold text-purple-600 dark:text-purple-400 uppercase tracking-widest mb-2 ml-3">重複截止日期</label><input type="date" value={repeatEndDate} onChange={(e) => setRepeatEndDate(e.target.value)} className="w-full h-14 bg-purple-50/50 dark:bg-purple-900/20 border border-purple-100 dark:border-purple-800/30 rounded-3xl px-5 text-[17px] outline-none focus:ring-4 focus:ring-purple-400/20 transition-all font-semibold tracking-wide text-purple-900 dark:text-purple-200 shadow-sm appearance-none"/></div>)}
                                        
                                        <div className="bg-white/50 dark:bg-zinc-800/50 rounded-[32px] p-5 border border-white/40 dark:border-white/10">
                                            <div className="flex justify-between items-center mb-6">
                                                <div><label className="text-[11px] font-bold text-gray-400 uppercase tracking-widest block mb-1">目前時薪</label><div className="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">${isSpecial ? specialRate : baseRate} <span className="text-sm text-gray-400 font-medium ml-1">/hr</span></div></div>
                                                <div className="flex items-center gap-4"><span className={`text-[13px] font-bold shrink-0 transition-colors ${!isSpecial ? 'text-blue-600 dark:text-blue-400' : 'text-gray-400'}`}>一般</span>
                                                <label className="relative inline-flex items-center cursor-pointer shrink-0">
                                                    <input type="checkbox" checked={isSpecial} onChange={(e) => setIsSpecial(e.target.checked)} className="sr-only peer" />
                                                    <div className="w-14 h-8 bg-blue-100 dark:bg-blue-900/40 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white spring-toggle after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:shadow-sm peer-checked:bg-pink-400"></div>
                                                </label>
                                                <span className={`text-[13px] font-bold shrink-0 transition-colors ${isSpecial ? 'text-pink-500' : 'text-gray-400'}`}>特殊</span></div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="relative"><label className="text-[10px] font-bold text-blue-400 absolute top-2 left-4">一般</label><input type="number" value={baseRate} onChange={(e) => setBaseRate(e.target.value)} className="w-full h-16 bg-white/70 dark:bg-zinc-700/50 border-0 rounded-2xl pt-5 px-4 text-center text-[19px] font-bold text-slate-700 dark:text-slate-200 outline-none focus:bg-white dark:focus:bg-zinc-600 transition-colors"/></div>
                                                <div className="relative"><label className="text-[10px] font-bold text-pink-400 absolute top-2 left-4">特殊</label><input type="number" value={specialRate} onChange={(e) => setSpecialRate(e.target.value)} className="w-full h-16 bg-white/70 dark:bg-zinc-700/50 border-0 rounded-2xl pt-5 px-4 text-center text-[19px] font-bold text-slate-700 dark:text-slate-200 outline-none focus:bg-white dark:focus:bg-zinc-600 transition-colors"/></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Fixed Footer (Button) */}
                                <div className="shrink-0 p-6 pt-2 bg-white/0">
                                    <button onClick={handleSaveShift} type="button" className="w-full h-14 bg-slate-900 dark:bg-white hover:bg-slate-800 dark:hover:bg-gray-200 text-white dark:text-black text-[17px] font-bold rounded-full shadow-xl shadow-slate-900/20 active:scale-95 transition-all">{editId ? '儲存變更' : (isRepeat ? '批次新增' : '新增班次')}</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>